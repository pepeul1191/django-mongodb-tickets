{% extends 'application.html' %}

{% block extra_css %}
<style>
  .form-check {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
  }

  #select-all{
    margin-right: 10px;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Checkbox para seleccionar/deseleccionar todos
  const selectAllCheckbox = document.getElementById('select-all');
  const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
  
  // Evento para el checkbox "Seleccionar todos"
  selectAllCheckbox.addEventListener('change', function() {
    employeeCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
  });
  
  // Evento para los checkboxes individuales
  employeeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (!this.checked) {
        selectAllCheckbox.checked = false;
      } else {
        // Verificar si todos los checkboxes están seleccionados
        const allChecked = Array.from(employeeCheckboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
      }
    });
  });

  // Botón Guardar Cambios
  document.querySelector('.btn-success').addEventListener('click', function(e) {
    e.preventDefault();
    // Crear lista de employees con su estado de selección
    const employeesData = Array.from(employeeCheckboxes).map(checkbox => {
      return {
        id: checkbox.value,
        selected: checkbox.checked
      };
    });

    // Crear objeto con todos los datos a enviar
    const formData = {
      employees: employeesData,
    };

    // Enviar datos al servidor
    fetch("{% url 'employees_enterprise' enterprise_id=enterprise_id %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(formData)
    })
    .then(response => {
      if (response.ok) {
        //window.location.reload(); // Recargar la página después de guardar
        alert('Cambios guardados correctamente');
      } else {
        alert('Error al guardar los cambios');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error al conectar con el servidor');
    });
  });
});
</script>
{% endblock %}

{% block content %}
<main class="main-content">
  <div class="container-fluid py-4">
    <h3 class="mb-4">
      <a class="return-nav" href="{% url 'enterprises_list' %}" ><i class="fa fa-industry me-2"></i>Gestión de Empresas</a> / Activos Relacionados
    </h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fa fa-filter me-2"></i>
          Filtros de Búsqueda
        </h6>
      </div>
      <div class="card-body">
        <form method="GET" action="{% url 'employees_enterprise' enterprise_id=enterprise_id  %}">
          <input type="hidden" name="per_page" value="{{ per_page }}">
          <div class="row mb-3 align-items-end">
            <div class="col-md-5">
              <label for="nombre" class="form-label">Buscar por Apellidos</label>
              <div class="input-group">
                <input type="text" id="nombre" name="name" class="form-control" placeholder="Buscar..." value="{{ search_query }}">
              </div>
            </div>
            <div class="col-md-3">
              <label for="email" class="form-label">Buscar por Correo</label>
              <div class="input-group">
                <input type="text" id="email" name="email" class="form-control" placeholder="Buscar por correo..." value="{{ email_query }}">
              </div>
            </div>
            <div class="col-md-2">
              <label for="association-filter" class="form-label">Filtrar por asociación</label>
              <div class="input-group">
                <select id="association-filter" name="association_status" class="form-select">
                  <option value="1" {% if association_status == 1 %}selected{% endif %}>Asociado</option>
                  <option value="0" {% if association_status == 0 %}selected{% endif %}>No Asociado</option>
                  <option value="2" {% if association_status == 2 %}selected{% endif %}>Todos</option>
                </select>
              </div>
            </div>
            <div class="col-md-2">
              <div class="input-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fa fa-search"></i> Buscar
                </button>
                <a href="{% url 'employees_enterprise' enterprise_id=enterprise_id %}" class="btn btn-secondary" style="margin-left: 10px;">
                  <i class="fa fa-refresh"></i> Limpiar
                </a>
              </div>
            </div>
          </div>
        </form>        
      </div>
    </div>
    
    <!-- Formulario principal que envía los checkboxes -->
      
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fa fa-list me-2"></i>
            Listado de Activos
          </h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center me-3">
              <label for="rows-per-page" class="form-label mb-0 me-2">Filas por página:</label>
              <form method="GET" id="per_page_form">
                <input type="hidden" name="name" value="{{ search_query }}">
                <select name="per_page" class="form-select" style="width: 120px;" onchange="this.form.submit()">
                  <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                  <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                  <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                  <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                  <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
              </form>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-success">
                <i class="fa fa-check"></i> Guardar Cambios
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Apellidos</th>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="select-all" name="select_all">
                      <label class="form-check-label" for="select-all">Asociado</label>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for employee in employees %}
                  <tr>
                    <td>{{ employee.last_names }}</td>
                    <td>{{ employee.names }}</td>
                    <td>{{ employee.email }}</td>
                    <td>
                      <div class="form-check">
                        <input class="form-check-input employee-checkbox" type="checkbox" 
                               name="selected_employees" value="{{ employee.id }}" {% if employee.associated %}checked{% endif %}>
                      </div>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center">No se encontraron activos.</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="5">
                    <div class="d-flex justify-content-between align-items-center mt-3">
                      <div class="text-left">
                        Página {{ page }} de {{ total_pages }} - Mostrando registros {{ start_record }} - {{ end_record }} de un total de {{ total_employees }}
                      </div>
  
                      <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                          <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{% url 'employees_enterprise' enterprise_id=enterprise_id %}?page=1&per_page={{ per_page }}&name={{ search_query }}" aria-label="First">
                              <i class="fa fa-angle-double-left"></i> Primero
                            </a>
                          </li>
  
                          <li class="page-item {% if page == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{% url 'employees_enterprise' enterprise_id=enterprise_id %}?page={{ page|add:"-1" }}&per_page={{ per_page }}&name={{ search_query }}" aria-label="Previous">
                              <i class="fa fa-angle-left"></i> Anterior
                            </a>
                          </li>
  
                          <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{% url 'employees_enterprise' enterprise_id=enterprise_id %}?page={{ page|add:"1" }}&per_page={{ per_page }}&name={{ search_query }}" aria-label="Next">
                              Siguiente <i class="fa fa-angle-right"></i>
                            </a>
                          </li>
  
                          <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                            <a class="page-link" href="{% url 'employees_enterprise' enterprise_id=enterprise_id %}?page={{ total_pages }}&per_page={{ per_page }}&name={{ search_query }}" aria-label="Last">
                              Último <i class="fa fa-angle-double-right"></i>
                            </a>
                          </li>
                        </ul>
                      </nav>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    
  </div>
</main>
{% endblock %}